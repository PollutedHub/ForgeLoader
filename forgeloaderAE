-- GITHUB PERSISTENT LOADER
-- Robust single Luarmor execution per server, fast rejoin safe

local QueueTeleport =
    queue_on_teleport
    or (syn and syn.queue_on_teleport)
    or (fluxus and fluxus.queue_on_teleport)

-- Ensure per-server executed table exists
if not _G.ExecutedServers then _G.ExecutedServers = {} end

local jobId = game.JobId

-- Use a per-server, per-executor session lock
if not _G.ExecutedServers[jobId] then
    -- Lock immediately to prevent race conditions
    _G.ExecutedServers[jobId] = true

    -- Queue loader for next hop (Luarmor NOT included)
    if QueueTeleport then
        QueueTeleport([[
            loadstring(game:HttpGet("https://raw.githubusercontent.com/PollutedHub/ForgeLoader/refs/heads/main/forgeloaderAE"))()
        ]])
        print("GitHub loader queued for next server")
    end

    -- Execute Luarmor immediately
    local success, err = pcall(function()
        loadstring(game:HttpGet("https://api.luarmor.net/files/v3/loaders/ecfcccea43f60fa4c46009f854c06a52.lua"))()
    end)

    if success then
        print("Luarmor executed on this server")
    else
        warn("Failed to execute Luarmor:", err)
    end
else
    print("Luarmor already executed on this server, skipping")
end
